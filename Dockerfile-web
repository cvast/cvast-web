FROM cvast-build.eastus.cloudapp.azure.com:5000/arches-complete

USER root

# Remove obsolete folders and packages
RUN apt-get purge -y --auto-remove postgis
RUN apt-get purge -y --auto-remove postgresql-9.4
RUN apt-get purge -y --auto-remove postgresql-server-dev-9.4
RUN apt-get purge -y --auto-remove postgresql-contrib-9.4
RUN apt-get autoremove -y 
RUN rm -rf /elasticsearch
RUN rm -rf /usr/share/postgresql

# Remove package list to free up space
RUN rm -rf /var/lib/apt/lists/*

ENV DJANGO_PASSWORD=admin

# For debugging with Visual Studio Code
RUN pip install ptvsd

ENV IS_CLEAN_ENV=false
ENV INSTALL_DIR=/install

# Entrypoint to setup volume mounts
COPY install/web/web_entrypoint.sh ${INSTALL_DIR}/web_entrypoint.sh
RUN chmod -R 700 ${INSTALL_DIR}
RUN dos2unix ${INSTALL_DIR}/*

VOLUME ["${WEB_ROOT}/${WEB_APP_NAME}/${WEB_APP_NAME}/uploadedfiles/files", "${WEB_ROOT}/${WEB_APP_NAME}/${WEB_APP_NAME}/logs"]
EXPOSE 8000 3000
WORKDIR ${WEB_ROOT}/${WEB_APP_NAME}
CMD ${INSTALL_DIR}/web_entrypoint.sh