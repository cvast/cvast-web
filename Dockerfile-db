# our base image
FROM cvast-build.eastus.cloudapp.azure.com:5000/arches-complete

USER root
WORKDIR /

# Path for volumes mounted to host
ENV PG_DATA_VOLUME=/postgres-data
ENV PG_CONFIG_VOLUME=/postgres-config
ENV PG_CONFIGFILE_VOLUME=${PG_CONFIG_VOLUME}/postgresql.conf
ENV PG_LOG_VOLUME=${PG_LOGDIR}
ENV INSTALL_DIR=/install
ENV IS_CLEAN_ENV=false
ENV PG_BINDIR=/usr/lib/postgresql/${PG_VERSION}/bin

# Remove obsolete folders
RUN rm -rf /cvast_web
RUN rm -rf /elasticsearch

# Cleanup database
USER postgres	
RUN ${PG_BINARY} start &&\
	psql -d ${PG_DBNAME} -c "VACUUM ANALYZE;" &&\
	${PG_BINARY} stop
USER root

# Entrypoint to setup volume mounts
COPY install/db/db_entrypoint.sh ${INSTALL_DIR}/db_entrypoint.sh
RUN chmod -R 700 ${INSTALL_DIR}

EXPOSE 5432
VOLUME  ["${PG_LOG_VOLUME}", "${PG_DATA_VOLUME}", "${PG_CONFIG_VOLUME}"]
CMD ${INSTALL_DIR}/db_entrypoint.sh
